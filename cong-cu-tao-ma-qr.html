<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công Cụ Tạo Mã QR</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@400;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ==================== CÁC BIẾN VÀ THIẾT LẬP CHUNG ==================== */
        :root {
            --bg-color: #12121e;
            --main-color: #f72585; /* Hồng neon */
            --accent-color: #4361ee; /* Xanh dương */
            --card-bg: #1e1e2d;
            --border-color: #2b2b3b;
            --text-color: #f0f0f0;
            --secondary-text-color: #a0a0a0;
            --button-success: #52b788;
            --button-danger: #e63964;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            padding-bottom: 60px;
        }

        h1, h2, h3, h4 {
            font-family: 'Poppins', sans-serif;
            color: var(--main-color);
            text-align: center;
            font-weight: 600;
        }
        
        /* ==================== HEADER & FOOTER ==================== */
        header.header-container {
            background-color: var(--card-bg);
            padding: 40px 20px 20px;
            text-align: center;
            border-bottom: 3px solid var(--accent-color);
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        header.header-container h1 {
            font-size: 2.5em;
            font-weight: 700;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            animation: none;
        }
        
        footer {
            background-color: var(--card-bg);
            text-align: center;
            padding: 20px;
            color: var(--secondary-text-color);
            border-top: 2px solid var(--accent-color);
        }

        /* ==================== GIAO DIỆN CHÍNH CỦA CÔNG CỤ ==================== */
        .qr-generator-container {
            max-width: 600px;
            margin: 30px auto;
            padding: 40px;
            text-align: center;
            background-color: var(--card-bg);
            border-radius: 15px;
            border: 2px solid;
            border-image: linear-gradient(45deg, var(--main-color), var(--accent-color)) 1;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        .qr-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            justify-content: center;
        }
        
        .qr-input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 1em;
        }

        .qr-code-box {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .download-btn, .qr-button {
            background-color: var(--accent-color);
            color: var(--text-color);
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        
        .download-btn:hover, .qr-button:hover {
            background-color: var(--main-color);
        }
        
        .qr-options {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            align-items: center;
        }
        
        .qr-option-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .qr-option-item label {
            font-size: 0.9em;
            color: var(--secondary-text-color);
            text-align: left;
        }

        .qr-option-item input[type="color"],
        .qr-option-item input[type="number"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .qr-option-item input[type="file"] {
            display: none;
        }
        
        .qr-option-item .file-upload-label {
            display: inline-block;
            padding: 8px 12px;
            background-color: var(--accent-color);
            color: var(--text-color);
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .qr-option-item input[type="number"], .qr-option-item select {
            width: 80px;
            height: auto;
            border-radius: 8px;
            padding: 5px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        .qr-option-item input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        
        .qr-option-item input[type="color"]::-webkit-color-swatch {
            border: 2px solid var(--border-color);
            border-radius: 50%;
        }
        
        .qr-option-item input[type="color"]:hover {
            transform: scale(1.1);
        }
        
        .download-formats {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .data-type-select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 1em;
            margin-bottom: 20px;
        }
        
        .qr-option-item .checkbox-label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            color: var(--secondary-text-color);
        }

        .qr-history-modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: none;
        }
        
        .qr-history-modal-content {
            background-color: var(--card-bg);
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 2px solid var(--main-color);
            animation: fadeIn 0.5s ease-out;
            text-align: left;
        }
        
        .qr-history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .qr-history-item {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color);
            text-align: center;
            font-size: 0.8em;
        }

        .qr-history-item img {
            width: 100%;
            height: auto;
            margin-bottom: 5px;
        }

        .qr-note {
            width: 100%;
            padding: 10px;
            margin-top: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 1em;
            box-sizing: border-box;
            resize: vertical;
        }


        /* ==================== MEDIA QUERIES (RESPONSIVE) ==================== */
        @media (max-width: 768px) {
            .qr-generator-container {
                padding: 20px;
            }
            .qr-input-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="qr-history-modal" class="qr-history-modal">
        <div class="qr-history-modal-content">
            <h3>Lịch Sử Mã QR</h3>
            <div id="qr-history-grid" class="qr-history-grid"></div>
            <button id="close-qr-history-btn" class="qr-button" style="margin-top: 20px;">Đóng</button>
        </div>
    </div>
    <header class="header-container">
        <h1>Công Cụ Tạo Mã QR</h1>
        <p>Tạo mã QR từ văn bản hoặc đường dẫn</p>
    </header>

    <main>
        <div class="qr-generator-container">
            <h2>Nhập Nội Dung</h2>
            <select id="data-type-select" class="data-type-select">
                <option value="text">Văn bản/URL</option>
                <option value="wifi">Wi-Fi</option>
                <option value="vcard">V-Card (Danh bạ)</option>
            </select>
            
            <div id="text-input-group">
                <input type="text" id="qr-text" class="qr-input" placeholder="Nhập đường dẫn hoặc văn bản...">
            </div>
            <div id="wifi-input-group" style="display: none;">
                <input type="text" id="wifi-ssid" class="qr-input" placeholder="Tên Wi-Fi (SSID)">
                <input type="password" id="wifi-password" class="qr-input" placeholder="Mật khẩu">
            </div>
            <div id="vcard-input-group" style="display: none;">
                <input type="text" id="vcard-name" class="qr-input" placeholder="Tên">
                <input type="text" id="vcard-phone" class="qr-input" placeholder="Số điện thoại">
                <input type="email" id="vcard-email" class="qr-input" placeholder="Email">
            </div>
            
            <div class="qr-options">
                <div class="qr-option-item">
                    <label>Màu Mã QR</label>
                    <input type="color" id="qr-color" value="#000000">
                </div>
                <div class="qr-option-item">
                    <label>Màu Nền</label>
                    <input type="color" id="qr-bg-color" value="#ffffff">
                </div>
                <div class="qr-option-item">
                    <label>Kích Thước</label>
                    <input type="number" id="qr-size" value="256" min="100" max="1024">
                </div>
                <div class="qr-option-item">
                    <label>Độ Nét</label>
                    <select id="qr-correction-level">
                        <option value="L">L (Thấp)</option>
                        <option value="M">M (Trung bình)</option>
                        <option value="Q">Q (Cao)</option>
                        <option value="H" selected>H (Rất cao)</option>
                    </select>
                </div>
                <div class="qr-option-item" style="text-align: center;">
                    <label>Logo</label>
                    <input type="file" id="logo-upload">
                    <label for="logo-upload" class="file-upload-label">Tải lên</label>
                </div>
                <div class="qr-option-item" style="text-align: center;">
                    <label class="checkbox-label">
                        <input type="checkbox" id="transparent-bg"> Nền trong suốt
                    </label>
                </div>
            </div>
            
            <div id="qrcode" class="qr-code-box"></div>
            
            <textarea id="qr-note" class="qr-note" placeholder="Thêm ghi chú cho mã QR này..."></textarea>
            
            <div class="download-formats">
                <button id="download-png" class="download-btn">Tải xuống PNG</button>
                <button id="download-svg" class="download-btn">Tải xuống SVG</button>
            </div>
            <div style="margin-top: 20px;">
                <button id="show-history-btn" class="qr-button">Lịch Sử Mã QR</button>
                <button id="share-btn" class="qr-button">Chia Sẻ</button>
            </div>
        </div>
    </main>

    <footer>
        <p>© 2025 Creative Hub. Bản quyền thuộc về Js Trung Kiên.</p>
    </footer>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dataTypeSelect = document.getElementById('data-type-select');
            const qrText = document.getElementById('qr-text');
            const wifiSsid = document.getElementById('wifi-ssid');
            const wifiPassword = document.getElementById('wifi-password');
            const vcardName = document.getElementById('vcard-name');
            const vcardPhone = document.getElementById('vcard-phone');
            const vcardEmail = document.getElementById('vcard-email');
            const qrcodeEl = document.getElementById('qrcode');
            const qrColor = document.getElementById('qr-color');
            const qrBgColor = document.getElementById('qr-bg-color');
            const qrSize = document.getElementById('qr-size');
            const qrCorrectionLevel = document.getElementById('qr-correction-level');
            const logoUpload = document.getElementById('logo-upload');
            const transparentBg = document.getElementById('transparent-bg');
            const downloadPngBtn = document.getElementById('download-png');
            const downloadSvgBtn = document.getElementById('download-svg');
            const showHistoryBtn = document.getElementById('show-history-btn');
            const historyModal = document.getElementById('qr-history-modal');
            const historyGrid = document.getElementById('qr-history-grid');
            const closeHistoryBtn = document.getElementById('close-qr-history-btn');
            const textInputGroup = document.getElementById('text-input-group');
            const wifiInputGroup = document.getElementById('wifi-input-group');
            const vcardInputGroup = document.getElementById('vcard-input-group');
            const qrNote = document.getElementById('qr-note');
            const shareBtn = document.getElementById('share-btn');
            
            let qrcodeInstance = null;
            let logoImage = null;

            function getQrData() {
                const type = dataTypeSelect.value;
                let data = '';
                if (type === 'text') {
                    data = qrText.value.trim() || 'https://www.google.com';
                } else if (type === 'wifi') {
                    const ssid = wifiSsid.value.trim();
                    const pass = wifiPassword.value.trim();
                    data = `WIFI:S:${ssid};T:WPA;P:${pass};;`;
                } else if (type === 'vcard') {
                    const name = vcardName.value.trim();
                    const phone = vcardPhone.value.trim();
                    const email = vcardEmail.value.trim();
                    data = `BEGIN:VCARD\nVERSION:3.0\nFN:${name}\nTEL:${phone}\nEMAIL:${email}\nEND:VCARD`;
                }
                return data;
            }
            
            function combineQrCodeAndLogo(qrCanvas, logo, noteText) {
                const finalCanvas = document.createElement('canvas');
                const ctx = finalCanvas.getContext('2d');
                const size = qrCanvas.width;
                const noteHeight = noteText ? 50 : 0;
                
                finalCanvas.width = size;
                finalCanvas.height = size + noteHeight;
                
                // Set background color
                ctx.fillStyle = transparentBg.checked ? 'transparent' : qrBgColor.value;
                ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
                
                // Draw QR code onto the final canvas
                ctx.drawImage(qrCanvas, 0, 0, size, size);

                // If there's a logo, draw it on top
                if (logo && logo.complete) {
                    const logoSize = size * 0.2;
                    const x = (size - logoSize) / 2;
                    const y = (size - logoSize) / 2;
                    ctx.drawImage(logo, x, y, logoSize, logoSize);
                }
                
                // Draw the note text below the QR code
                if (noteText) {
                    ctx.fillStyle = '#000000';
                    ctx.font = '16px Poppins, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(noteText, size / 2, size + 30);
                }
                
                return finalCanvas;
            }


            function generateQrCode() {
                const textValue = getQrData();
                const color = qrColor.value;
                const bgColor = transparentBg.checked ? 'transparent' : qrBgColor.value;
                const size = parseInt(qrSize.value);
                const correctionLevel = qrCorrectionLevel.value;

                if (qrcodeInstance) {
                    qrcodeInstance.clear();
                    qrcodeInstance = null;
                }
                
                qrcodeInstance = new QRCode(qrcodeEl, {
                    text: textValue,
                    width: size,
                    height: size,
                    colorDark: color,
                    colorLight: bgColor,
                    correctLevel: QRCode.CorrectLevel[correctionLevel]
                });
                
                // Wait for the QR code to finish rendering its canvas
                setTimeout(() => {
                    const qrCanvas = qrcodeEl.querySelector('canvas');
                    if (qrCanvas) {
                        const finalCanvas = combineQrCodeAndLogo(qrCanvas, logoImage, qrNote.value.trim());
                        qrcodeEl.innerHTML = '';
                        qrcodeEl.appendChild(finalCanvas);
                        saveToHistory(finalCanvas);
                    }
                }, 50);

            }
            

            function saveToHistory(canvas) {
                const history = JSON.parse(localStorage.getItem('qr-history')) || [];
                const qrDataUrl = canvas.toDataURL("image/png");
                const historyItem = {
                    data: getQrData(),
                    url: qrDataUrl,
                    note: qrNote.value.trim()
                };
                
                const isDuplicate = history.some(item => item.url === qrDataUrl);
                if (!isDuplicate) {
                    history.unshift(historyItem);
                    if (history.length > 10) {
                        history.pop();
                    }
                    localStorage.setItem('qr-history', JSON.stringify(history));
                }
            }
            
            function renderHistory() {
                const history = JSON.parse(localStorage.getItem('qr-history')) || [];
                historyGrid.innerHTML = '';
                if (history.length === 0) {
                    historyGrid.innerHTML = '<p>Chưa có mã QR nào được tạo.</p>';
                    return;
                }
                history.forEach(item => {
                    const div = document.createElement('div');
                    div.classList.add('qr-history-item');
                    div.innerHTML = `<img src="${item.url}" alt="QR Code"><p>${item.data}</p>`;
                    historyGrid.appendChild(div);
                });
            }


            generateQrCode();

            dataTypeSelect.addEventListener('change', () => {
                textInputGroup.style.display = 'none';
                wifiInputGroup.style.display = 'none';
                vcardInputGroup.style.display = 'none';
                
                if (dataTypeSelect.value === 'text') textInputGroup.style.display = 'block';
                if (dataTypeSelect.value === 'wifi') wifiInputGroup.style.display = 'block';
                if (dataTypeSelect.value === 'vcard') vcardInputGroup.style.display = 'block';
                
                generateQrCode();
            });

            qrText.addEventListener('input', generateQrCode);
            wifiSsid.addEventListener('input', generateQrCode);
            wifiPassword.addEventListener('input', generateQrCode);
            vcardName.addEventListener('input', generateQrCode);
            vcardPhone.addEventListener('input', generateQrCode);
            vcardEmail.addEventListener('input', generateQrCode);
            qrColor.addEventListener('input', generateQrCode);
            qrBgColor.addEventListener('input', generateQrCode);
            qrSize.addEventListener('input', generateQrCode);
            qrCorrectionLevel.addEventListener('change', generateQrCode);
            transparentBg.addEventListener('change', generateQrCode);
            qrNote.addEventListener('input', generateQrCode);

            logoUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        logoImage = new Image();
                        logoImage.src = e.target.result;
                        logoImage.onload = generateQrCode;
                    };
                    reader.readAsDataURL(file);
                } else {
                    logoImage = null;
                    generateQrCode();
                }
            });

            downloadPngBtn.addEventListener('click', () => {
                const canvas = qrcodeEl.querySelector('canvas');
                if (canvas) {
                    const qrDataUrl = canvas.toDataURL("image/png");
                    const link = document.createElement('a');
                    link.href = qrDataUrl;
                    link.download = 'qrcode.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });
            
            downloadSvgBtn.addEventListener('click', () => {
                const svg = qrcodeEl.querySelector('svg');
                if (svg) {
                    const svgDataUrl = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svg.outerHTML)}`;
                    const link = document.createElement('a');
                    link.href = svgDataUrl;
                    link.download = 'qrcode.svg';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });
            
            showHistoryBtn.addEventListener('click', () => {
                renderHistory();
                historyModal.style.display = 'block';
            });

            closeHistoryBtn.addEventListener('click', () => {
                historyModal.style.display = 'none';
            });

            shareBtn.addEventListener('click', async () => {
                const finalCanvas = qrcodeEl.querySelector('canvas');
                if (!finalCanvas) return;

                const blob = await new Promise(resolve => finalCanvas.toBlob(resolve, 'image/png'));
                const file = new File([blob], 'qrcode.png', { type: 'image/png' });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: 'Mã QR đã tạo',
                            text: qrNote.value.trim() || 'Chia sẻ mã QR từ Công Cụ Tạo Mã QR',
                        });
                        alert('Đã chia sẻ thành công!');
                    } catch (error) {
                        alert('Chia sẻ thất bại: ' + error.message);
                    }
                } else {
                    alert('Trình duyệt không hỗ trợ chia sẻ.');
                }
            });
        });
    </script>
</body>
</html>